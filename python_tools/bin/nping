#!/usr/bin/env python3
"""
nping - Ping Z1 cluster nodes

Unix-style utility to test connectivity to Z1 cluster nodes.
"""

import sys
import os
import argparse
import time

# Add lib directory to path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..', 'lib'))

from z1_client import Z1Client, Z1ClusterError


def ping_node(client: Z1Client, node_id: int, count: int, verbose: bool = False) -> tuple:
    """
    Ping a node multiple times.
    
    Returns:
        (success_count, total_count, min_latency, max_latency, avg_latency)
    """
    latencies = []
    success_count = 0
    
    for i in range(count):
        if verbose:
            print(f"Pinging node {node_id}... ", end='', flush=True)
        
        success, latency = client.ping_node(node_id)
        
        if success:
            success_count += 1
            latencies.append(latency)
            if verbose:
                print(f"OK (time={latency:.2f}ms)")
        else:
            if verbose:
                print("FAILED")
        
        if i < count - 1:
            time.sleep(0.5)  # Wait between pings
    
    if latencies:
        min_lat = min(latencies)
        max_lat = max(latencies)
        avg_lat = sum(latencies) / len(latencies)
    else:
        min_lat = max_lat = avg_lat = 0.0
    
    return (success_count, count, min_lat, max_lat, avg_lat)


def main():
    parser = argparse.ArgumentParser(
        description='Ping Z1 cluster nodes to test connectivity',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  nping 0                Ping node 0
  nping all              Ping all nodes
  nping 0 -n 10          Ping node 0 ten times
  nping all -v           Ping all nodes with verbose output
        """
    )
    
    parser.add_argument('node',
                       help='Node ID (0-15) or "all"')
    parser.add_argument('-c', '--controller',
                       default=None,
                       help='Controller IP address (overrides environment/config)')
    parser.add_argument('-n', '--count',
                       type=int,
                       default=4,
                       help='Number of pings (default: 4)')
    parser.add_argument('-v', '--verbose',
                       action='store_true',
                       help='Verbose output')
    
    args = parser.parse_args()
    
    try:
        client = Z1Client(controller_ip=args.controller)
        
        # Determine which nodes to ping
        if args.node.lower() == 'all':
            # Discover active nodes
            print("Discovering nodes...", flush=True)
            node_ids = client.discover_nodes()
            if not node_ids:
                print("No active nodes found", file=sys.stderr)
                return 1
            print(f"Found {len(node_ids)} active nodes\n")
        else:
            try:
                node_id = int(args.node)
                if node_id < 0 or node_id > 15:
                    print("Error: Node ID must be 0-15", file=sys.stderr)
                    return 1
                node_ids = [node_id]
            except ValueError:
                print(f"Error: Invalid node ID '{args.node}'", file=sys.stderr)
                return 1
        
        # Ping each node
        all_success = True
        for node_id in node_ids:
            if len(node_ids) > 1:
                print(f"--- Node {node_id} ---")
            
            success_count, total_count, min_lat, max_lat, avg_lat = ping_node(
                client, node_id, args.count, args.verbose
            )
            
            # Print summary
            loss_pct = ((total_count - success_count) / total_count) * 100
            print(f"\n{total_count} packets transmitted, {success_count} received, "
                  f"{loss_pct:.1f}% packet loss")
            
            if success_count > 0:
                print(f"rtt min/avg/max = {min_lat:.2f}/{avg_lat:.2f}/{max_lat:.2f} ms")
            
            if success_count < total_count:
                all_success = False
            
            if len(node_ids) > 1:
                print()  # Blank line between nodes
        
        return 0 if all_success else 1
        
    except Z1ClusterError as e:
        print(f"Error: {e}", file=sys.stderr)
        return 1
    except KeyboardInterrupt:
        print("\nInterrupted", file=sys.stderr)
        return 130


if __name__ == '__main__':
    sys.exit(main())
